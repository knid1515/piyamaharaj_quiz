<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบทดสอบวันปิยมหาราช</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 id="page-title">วันปิยมหาราช</h1>

        <div id="article-section">
            <div class="article-content">
                <h2>ความสำคัญของวันปิยมหาราช</h2>
                <p><strong>วันปิยมหาราช</strong> ตรงกับวันที่ 23 ตุลาคมของทุกปี เป็นวันคล้ายวันสวรรคตของพระบาทสมเด็จพระจุลจอมเกล้าเจ้าอยู่หัว (รัชกาลที่ 5)...</p>
                <div class="article-image-container">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1d/King_Rama_V_equestrian_statue.jpg/600px-King_Rama_V_equestrian_statue.jpg" 
                         alt="พระบรมรูปทรงม้า" 
                         title="พระบรมรูปทรงม้า พระบาทสมเด็จพระจุลจอมเกล้าเจ้าอยู่หัว">
                    <p class="image-caption">พระบรมรูปทรงม้า พระบาทสมเด็จพระจุลจอมเกล้าเจ้าอยู่หัว (ที่มา: Wikipedia)</p>
                </div>
            </div>
            <button id="start-quiz-button">ฉันอ่านจบแล้ว! เริ่มทำแบบทดสอบ</button>
        </div>

        <div id="quiz-section" style="display: none;">
            <h1 id="quiz-header">แบบทดสอบวันปิยมหาราช</h1>

            <form id="quiz-form"></form>
            
            <div id="results" class="results-container" style="display: none;">
                <p id="score"></p>
                <div id="answer-details"></div>
                <div id="post-quiz-action"></div>
            </div>

            <div id="certificate-wrapper">
                <div id="certificate" class="certificate-container" style="display: none;">
                    <div class="certificate-header">
                        <h2>ใบเกียรติบัตร</h2>
                        <h3>Certificate of Achievement</h3>
                    </div>
                    <div class="certificate-body">
                        <p>มอบให้แด่</p>
                        <h1 id="cert-name" class="cert-name"></h1>
                        <p>เนื่องในโอกาสผ่านการทดสอบความรู้ "วันปิยมหาราช"</p>
                        <p>ด้วยคะแนนยอดเยี่ยม</p>
                        <h2 id="cert-score"></h2>
                    </div>
                    <div class="certificate-footer">
                        <p>ให้ไว้ ณ วันที่ <span id="cert-date"></span></p>
                    </div>
                </div>
                <div id="download-button-container" class="download-button-container" style="display: none;">
                    <button id="download-cert-button" title="ดาวน์โหลดเกียรติบัตร">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        <span>ดาวน์โหลด</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const quizData = [
            { question: "วันปิยมหาราชตรงกับวันที่เท่าใดของทุกปี", options: ["5 ธันวาคม", "23 ตุลาคม", "13 ตุลาคม", "10 ธันวาคม"], correctAnswer: "23 ตุลาคม" },
            { question: "'พระปิยมหาราช' เป็นพระราชสมัญญานามของพระมหากษัตริย์รัชกาลใด", options: ["รัชกาลที่ 4", "รัชกาลที่ 9", "รัชกาลที่ 5", "รัชกาลที่ 6"], correctAnswer: "รัชกาลที่ 5" },
            { question: "พระราชกรณียกิจที่สำคัญที่สุดข้อหนึ่งของรัชกาลที่ 5 คืออะไร", options: ["การเลิกทาส", "การสร้างสนามบิน", "การประดิษฐ์อักษรไทย", "การเปลี่ยนชื่อประเทศ"], correctAnswer: "การเลิกทาส" },
            { question: "ข้อใดไม่ใช่พระราชกรณียกิจในสมัยรัชกาลที่ 5", options: ["การสร้างการรถไฟ", "การปฏิรูประบบราชการ", "การจัดตั้งกิจการไปรษณีย์", "การก่อตั้งธนาคารแห่งประเทศไทย"], correctAnswer: "การก่อตั้งธนาคารแห่งประเทศไทย" },
            { question: "คำว่า 'ปิยมหาราช' มีความหมายตรงกับข้อใด", options: ["พระมหากษัตริย์ผู้ยิ่งใหญ่", "พระมหากษัตริย์นักพัฒนา", "พระมหากษัตริย์ที่ทรงเป็นที่รักยิ่งของปวงชน", "พระมหากษัตริย์ผู้ทรงธรรม"], correctAnswer: "พระมหากษัตริย์ที่ทรงเป็นที่รักยิ่งของปวงชน" },
            { question: "โรงพยาบาลหลวงแห่งแรกของไทยที่สร้างขึ้นในสมัยรัชกาลที่ 5 คือโรงพยาบาลใด", options: ["โรงพยาบาลจุฬาลงกรณ์", "โรงพยาบาลศิริราช", "โรงพยาบาลรามาธิบดี", "โรงพยาบาลพระมงกุฎเกล้า"], correctAnswer: "โรงพยาบาลศิริราช" },
            { question: "รัชกาลที่ 5 ทรงเป็นพระมหากษัตริย์ไทยพระองค์แรกที่ทรงทำสิ่งใด", options: ["เสด็จประพาสยุโรป", "ทรงผนวช", "มีพระราชโอรส", "ครองราชย์ครบ 50 ปี"], correctAnswer: "เสด็จประพาสยุโรป" },
            { question: "ระบบการปกครองส่วนภูมิภาคที่เรียกว่า 'มณฑลเทศาภิบาล' เกิดขึ้นในรัชสมัยใด", options: ["รัชกาลที่ 4", "รัชกาลที่ 5", "รัชกาลที่ 6", "รัชกาลที่ 7"], correctAnswer: "รัชกาลที่ 5" },
            { question: "พระบรมราชานุสาวรีย์ที่สำคัญของรัชกาลที่ 5 คือ 'พระบรมรูปทรงม้า' ประดิษฐานอยู่ที่ใด", options: ["สนามหลวง", "อนุสาวรีย์ชัยสมรภูมิ", "ลานพระราชวังดุสิต", "วงเวียนใหญ่"], correctAnswer: "ลานพระราชวังดุสิต" },
            { question: "สิ่งใดที่ถูกนำมาใช้เป็นครั้งแรกในสมัยรัชกาลที่ 5 เพื่อพัฒนาระบบเศรษฐกิจการเงิน", options: ["บัตรเครดิต", "เงินพดด้วง", "เหรียญกษาปณ์", "ธนบัตร"], correctAnswer: "ธนบัตร" }
        ];

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const userName = localStorage.getItem('quizUserName') || "ผู้ทำแบบทดสอบ";
            document.getElementById('quiz-header').textContent = `แบบทดสอบวันปิยมหาราช (โดย ${userName})`;

            document.getElementById('start-quiz-button').addEventListener('click', () => {
                document.getElementById('article-section').style.display = 'none';
                document.getElementById('page-title').textContent = document.getElementById('quiz-header').textContent;
                document.getElementById('quiz-section').style.display = 'block';
                generateQuiz();
            });

            // ! เพิ่ม Event Listener ให้ปุ่มดาวน์โหลด
            document.getElementById('download-cert-button').addEventListener('click', downloadCertificate);
        });

        function generateQuiz() {
            const quizForm = document.getElementById('quiz-form');
            shuffleArray(quizData);
            let quizHTML = '';
            quizData.forEach((questionData, index) => {
                quizHTML += `<div class="question"><p>${index + 1}. ${questionData.question}</p>`;
                const shuffledOptions = [...questionData.options];
                shuffleArray(shuffledOptions);
                quizHTML += `<div class="options">`;
                shuffledOptions.forEach(option => {
                    quizHTML += `
                        <div>
                            <input type="radio" name="q${index}" id="q${index}_${option}" value="${option}">
                            <label for="q${index}_${option}">${option}</label>
                        </div>
                    `;
                });
                quizHTML += `</div></div>`;
            });
            quizHTML += `<button type="submit">ส่งคำตอบ</button>`;
            quizForm.innerHTML = quizHTML;
            quizForm.addEventListener('submit', handleSubmit);
        }

        function handleSubmit(event) {
            event.preventDefault();
            let score = 0;
            let answerDetailsHTML = '<h3>เฉลยแบบทดสอบ</h3>';
            quizData.forEach((data, index) => {
                const userAnswer = (event.target.elements[`q${index}`] || {}).value;
                answerDetailsHTML += `<div class="answer-review"><p><strong>${index + 1}. ${data.question}</strong></p>`;
                if (userAnswer) {
                    if (userAnswer === data.correctAnswer) {
                        score++;
                        answerDetailsHTML += `<p>คุณตอบ: <span class="correct">${userAnswer} (ถูกต้อง)</span></p>`;
                    } else {
                        answerDetailsHTML += `<p>คุณตอบ: <span class="incorrect">${userAnswer} (ผิด)</span></p>`;
                        answerDetailsHTML += `<p class="correct-answer-text">เฉลย: ${data.correctAnswer}</p>`;
                    }
                } else {
                    answerDetailsHTML += `<p class="incorrect">คุณไม่ได้ตอบข้อนี้</p>`;
                    answerDetailsHTML += `<p class="correct-answer-text">เฉลย: ${data.correctAnswer}</p>`;
                }
                answerDetailsHTML += `</div><hr>`;
            });

            document.getElementById('quiz-form').style.display = 'none';
            document.getElementById('quiz-header').style.display = 'none';

            if (score >= 8) {
                const userName = localStorage.getItem('quizUserName') || "ผู้ทำแบบทดสอบ";
                const today = new Date();
                const dateString = today.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });

                document.getElementById('cert-name').textContent = userName;
                document.getElementById('cert-score').textContent = `${score} / ${quizData.length} คะแนน`;
                document.getElementById('cert-date').textContent = dateString;
                document.getElementById('certificate').style.display = 'block';
                // ! แสดงปุ่มดาวน์โหลด
                document.getElementById('download-button-container').style.display = 'block';

            } else {
                const resultsContainer = document.getElementById('results');
                document.getElementById('score').textContent = `คุณได้ ${score} จาก ${quizData.length} คะแนน`;
                document.getElementById('answer-details').innerHTML = answerDetailsHTML;
                
                const postQuizAction = document.getElementById('post-quiz-action');
                postQuizAction.innerHTML = '';
                const retryButton = document.createElement('button');
                retryButton.textContent = 'ลองใหม่อีกครั้ง';
                retryButton.className = 'retry-button';
                retryButton.onclick = () => window.location.reload(); 
                postQuizAction.appendChild(retryButton);
                
                resultsContainer.style.display = 'block';
            }
        }
        
        // ! เพิ่มฟังก์ชันสำหรับดาวน์โหลด
        function downloadCertificate() {
            const certificateElement = document.getElementById('certificate');
            const userName = localStorage.getItem('quizUserName') || "user";
            const filename = `Certificate-Piyamaharaj-${userName.replace(/\s/g, '_')}.png`;

            // ใช้ html2canvas เพื่อ "ถ่ายภาพ" div ของเกียรติบัตร
            html2canvas(certificateElement, {
                scale: 2 // เพิ่มความละเอียดของภาพเป็น 2 เท่า
            }).then(canvas => {
                // แปลง canvas เป็น URL ของรูปภาพ
                const imageURL = canvas.toDataURL('image/png');

                // สร้างลิงก์ชั่วคราวขึ้นมาเพื่อดาวน์โหลด
                const downloadLink = document.createElement('a');
                downloadLink.href = imageURL;
                downloadLink.download = filename;

                // สั่งให้เบราว์เซอร์คลิกที่ลิงก์นี้
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            });
        }
    </script>
</body>
</html>
